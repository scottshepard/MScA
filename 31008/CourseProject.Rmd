---
title: "Genre Predictions"
author: "Scott Shepard"
subtitle: "Trees, Random Forest, and Multinomial Logit"
date: "8/12/2018"
output: pdf_document
---

```{r libraries}
library(dplyr)
library(ggplot2)
library(stringr)
library(reshape2)
library(rpart)
```

```{r read_data}
# Read Data
path <- "~/Dropbox/MScA/31008 - Data Mining/Project/fma_metadata/"

special_read_csv <- function(file_path, n_rows=-1, offset=0) {
  # The flat files in this project are formatted for easy python loading. 
  # The headers are a multilevel index. 
  # The first row is the category: track, album, artist, or set. 
  # The second row is the column name: id, producer, name, etc
  # Togther they make up the full column name. These need to be read in 
  # separately and manually pasted together to get the full column names.
  row0 <- read.csv(file_path, nrows=1, skip=0+offset)
  row1 <- read.csv(file_path, nrows=1, skip=1+offset)
  
  df <- read.csv(file_path, nrows=n_rows, skip=2+offset)
  headers <- paste(
    str_replace_all(names(row0), c("\\."="", "[0-9]+"="")), 
    str_replace_all(names(row1), c("\\."="_")), 
    sep="_")
  headers[1] <- "track_id"
  names(df) <- headers
  df
}

# tracks <- special_read_csv(file.path(path, "tracks.csv"))
# echonest <- special_read_csv(file.path(path, "echonest.csv"), offset=1)[,1:26]
# df <- dplyr::inner_join(tracks, echonest, "track_id")
```

```{r clean_data}
df <- read.csv(file.path(path, "Tracks_Echonest_Merged.csv"))

names(df)[names(df) == "track_genre_top"] <- "genre"
df$genre <- as.character(df$genre)
df <- df[! df$genre %in% c("", "International", "Experimental"), ]
df$genre <- factor(df$genre)

names(df)[grepl("audio_features_", names(df))] <- 
  str_remove(names(df)[grepl("audio_features_", names(df))], "audio_features_")

df$tempo_scaled <- scales::rescale(df$tempo)
```

```{r}
splitData <- function(data, smp_size) {
  # Take a dataset and split it randomly into train and test sets
  # The size of the training set is the smp_size argument
  train_ind <- sample(seq_len(nrow(data)), size = smp_size)
  train <- data[ train_ind, ]
  test  <- data[-train_ind, ]
  
  list("train"=train, "test"=test)
}
```

```{r exploration}
ggplot(df, aes(x=genre)) + 
  geom_bar(stat='count') +
  theme(axis.text.x = element_text(angle=90)) + 
  labs(title="Frequency of Genres within Dataset",
       x="")

table(df$genre)
```

```{r}
audio_feature_cols = c("acousticness", "danceability", "energy", 
                       "instrumentalness", "liveness", "speechiness", 
                       "tempo_scaled", "valence")

melted <- melt(df, id.vars=c("genre", "track_id"),
               measure.vars=audio_feature_cols,
               variable.name="audio_feature")
melted$audio_feature <- str_remove(melted$audio_feature, "audio_features_")
```

```{r}
ggplot(melted, aes(x=value)) + 
  geom_density(aes(y=..scaled..)) + 
  facet_grid(genre~audio_feature) + 
  labs(title="Density of Each Audio Feature with Genre")
```

Split the data

```{r data_holdout}
set.seed(123)
l <- splitData(df, round(nrow(df) * 0.7))
train <- l$train
holdout <- l$test
```

## Simple Classification Tree

```{r trees}
x = rpart(genre ~ acousticness + danceability + energy + instrumentalness + 
            liveness + speechiness + tempo + valence,
          data=train, control=rpart.control(cp=0, minsplit=10, xval=10))

plotcp(x)
printcp(x)
CP <- x$cptable[x$cptable[,'xerror'] == min(x$cptable[,'xerror']), 'CP']
CP
```

Final Model

```{r}
xp = rpart(genre ~ acousticness + danceability + energy + instrumentalness + 
             liveness + speechiness + tempo + valence,
           data=train, control=rpart.control(cp=CP, minsplit=10, xval=10))

train$pg <- predict(xp, type="class")
```

Model Validation

```{r}
prop.table(table(train$genre, train$pg))

accuracy <- train %>%
  group_by(pg) %>%
  summarize(pct=mean(pg == genre))
ggplot(accuracy, aes(x=pg, y=pct)) + 
  geom_bar(stat="identity") + 
  scale_y_continuous(labels=scales::percent) +
  theme(axis.title.x = element_blank()) +
  labs(title="Preciction Accuracy -- Training Data",
       subtitle="Given a Prection, How Likely is it to be true?",
       y="Percent of Values Predicted Correctly")

correct_classify <- train %>%
  group_by(genre) %>%
  summarize(pct=mean(pg == genre))
ggplot(correct_classify, aes(x=genre, y=pct)) + 
  geom_bar(stat="identity") +
  scale_y_continuous(labels=scales::percent) +
  theme(axis.title.x = element_blank()) +
  labs(title="Correct Classification -- Training Data",
       subtitle="Given a track, how likely is it to be correctly classified",
       y="Percent of Observations Correctly Classified")

table(train[,c('genre', 'pg')])
```

Holdout validation

```{r}
holdout$pg <- predict(xp, type="class", newdata = holdout)

table(holdout$genre, holdout$pg)

accuracy <- holdout %>%
  group_by(pg) %>%
  summarize(pct=mean(pg == genre))
ggplot(accuracy, aes(x=pg, y=pct)) + 
  geom_bar(stat="identity") + 
  scale_y_continuous(labels=scales::percent) +
  theme(axis.title.x = element_blank()) +
  labs(title="Preciction Accuracy -- Holdout Data",
       subtitle="Given a Prection, How Likely is it to be true?",
       y="Percent of Values Predicted Correctly")

correct_classify <- holdout %>%
  group_by(genre) %>%
  summarize(pct=mean(pg == genre))
ggplot(correct_classify, aes(x=genre, y=pct)) + 
  geom_bar(stat="identity") +
  scale_y_continuous(labels=scales::percent) +
  theme(axis.title.x = element_blank()) +
  labs(title="Correct Classification -- Holdout Data",
       subtitle="Given a track, how likely is it to be correctly classified?",
       y="Percent of Observations Correctly Classified")
```
